--- net/core/sock_diag.c	2012-05-21 00:29:13.000000000 +0200
+++ net/core/sock_diag.c	2014-01-08 18:42:33.000000000 +0100
@@ -126,6 +126,9 @@
 	if (nlmsg_len(nlh) < sizeof(*req))
 		return -EINVAL;
 
+	if (req->sdiag_family >= AF_MAX)
+		return -EINVAL;
+
 	hndl = sock_diag_lock_handler(req->sdiag_family);
 	if (hndl == NULL)
 		err = -ENOENT;
